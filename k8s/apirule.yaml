# Simulator Poste - Kyma APIRule v2
# Exposes frontend and backend services via Kyma gateway
apiVersion: gateway.kyma-project.io/v2
kind: APIRule
metadata:
  name: simulator-poste
  namespace: simulator-poste
  labels:
    app: simulator-poste
spec:
  # Host for the application
  hosts:
    - simulator-poste.c-6dc1be8.kyma.ondemand.com

  # The Kyma gateway to use
  gateway: kyma-system/kyma-gateway

  # Default service (frontend for SPA)
  service:
    name: frontend-service
    port: 80

  # Access rules
  rules:
    # OPTIONS preflight - must be noAuth for CORS to work
    - path: /api/{**}
      methods:
        - OPTIONS
      noAuth: true
      service:
        name: backend-service
        port: 8000

    # API routes - JWT required (token issued by SAP IAS)
    - path: /api/{**}
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - PATCH
      jwt:
        authentications:
          - issuer: "https://asojzafbi.accounts.ondemand.com"
            jwksUri: "https://asojzafbi.accounts.ondemand.com/oauth2/certs"
            audiences:
              - "c763a5f1-287c-4115-93bc-61e06b1bd7a3"
      service:
        name: backend-service
        port: 8000

    # Health endpoints - no auth (used by Kyma health checks)
    - path: /health/{**}
      methods:
        - GET
      noAuth: true
      service:
        name: backend-service
        port: 8000

    # All other routes - frontend SPA (OIDC handled client-side)
    - path: /*
      methods:
        - GET
        - OPTIONS
      noAuth: true
