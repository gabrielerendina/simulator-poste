name: Deploy to Kyma

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    branches: [kyma, main]
    types: [completed]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to SAP BTP Kyma
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: Configure Kyma kubeconfig
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KYMA_KUBECONFIG }}" | base64 -d > ~/.kube/config
        chmod 600 ~/.kube/config

    - name: Verify cluster connection
      run: |
        echo "Testing cluster connection..."
        kubectl get pods -n simulator-poste 2>/dev/null || echo "Namespace ready"

    # OIDC secrets are already configured in Kyma namespace
    # No need to create them via workflow

    - name: Apply ConfigMaps
      run: |
        kubectl apply -f k8s/backend/configmap.yaml
        kubectl apply -f k8s/frontend/configmap.yaml

    - name: Apply Backend resources
      run: |
        kubectl apply -f k8s/backend/deployment.yaml
        kubectl apply -f k8s/backend/service.yaml

    - name: Apply Frontend resources
      run: |
        kubectl apply -f k8s/frontend/deployment.yaml
        kubectl apply -f k8s/frontend/service.yaml

    - name: Apply APIRule
      run: |
        kubectl apply -f k8s/apirule.yaml

    - name: Restart deployments
      run: |
        kubectl rollout restart deployment/simulator-poste-backend -n simulator-poste
        kubectl rollout restart deployment/simulator-poste-frontend -n simulator-poste

    - name: Wait for backend rollout
      run: |
        kubectl rollout status deployment/simulator-poste-backend -n simulator-poste --timeout=5m

    - name: Wait for frontend rollout
      run: |
        kubectl rollout status deployment/simulator-poste-frontend -n simulator-poste --timeout=5m

    - name: Verify deployment
      run: |
        echo "=== Backend Deployment ==="
        kubectl get deployment simulator-poste-backend -n simulator-poste
        kubectl get pods -l app=simulator-poste-backend -n simulator-poste

        echo "=== Frontend Deployment ==="
        kubectl get deployment simulator-poste-frontend -n simulator-poste
        kubectl get pods -l app=simulator-poste-frontend -n simulator-poste

        echo "=== Services ==="
        kubectl get services -n simulator-poste

        echo "=== APIRule ==="
        kubectl get apirules -n simulator-poste

    - name: Output deployment URL
      run: |
        echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**URL:** https://simulator-poste.b66a502.kyma.ondemand.com" >> $GITHUB_STEP_SUMMARY

    - name: Cleanup kubeconfig
      if: always()
      run: |
        rm -f ~/.kube/config
